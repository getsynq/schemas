{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.synq.io/synq-recon/draft/audit-log.schema.json",
  "$defs": {
    "AuditMeta": {
      "properties": {
        "version": {
          "type": "string",
          "description": "Module version or tag (e.g. v1.2.3)"
        },
        "vcs_commit": {
          "type": "string",
          "description": "VCS revision hash"
        },
        "vcs_time": {
          "type": "string",
          "description": "VCS commit timestamp (RFC3339)"
        },
        "vcs_dirty": {
          "type": "boolean",
          "description": "True if the working tree had uncommitted changes"
        },
        "go_version": {
          "type": "string",
          "description": "Go toolchain version used to build the binary"
        }
      },
      "type": "object"
    },
    "DatasetInfo": {
      "properties": {
        "connection": {
          "type": "string"
        },
        "dialect": {
          "type": "string"
        },
        "query": {
          "type": "string"
        }
      },
      "type": "object",
      "required": [
        "connection",
        "query"
      ]
    },
    "Normalization": {
      "properties": {
        "source_columns": {
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "target_columns": {
          "items": {
            "type": "string"
          },
          "type": "array"
        }
      },
      "type": "object"
    },
    "QueryRecord": {
      "properties": {
        "id": {
          "type": "string"
        },
        "role": {
          "type": "string",
          "enum": [
            "source",
            "target"
          ]
        },
        "connection": {
          "type": "string"
        },
        "dialect": {
          "type": "string"
        },
        "sql": {
          "type": "string"
        },
        "started_at": {
          "type": "string",
          "format": "date-time"
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0
        },
        "rows_returned": {
          "type": "integer",
          "minimum": 0
        },
        "error": {
          "type": "string"
        },
        "retry_attempt": {
          "type": "integer",
          "minimum": 0
        }
      },
      "type": "object",
      "required": [
        "id",
        "role",
        "connection",
        "sql",
        "started_at",
        "duration_ms"
      ]
    },
    "ReconciliationAudit": {
      "properties": {
        "name": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "mode": {
          "type": "string",
          "enum": [
            "row_count",
            "full",
            "aggregate"
          ]
        },
        "config": true,
        "raw_config": true,
        "source": {
          "$ref": "#/$defs/DatasetInfo"
        },
        "target": {
          "$ref": "#/$defs/DatasetInfo"
        },
        "original_source_query": {
          "type": "string"
        },
        "original_target_query": {
          "type": "string"
        },
        "key_column": {
          "type": "string"
        },
        "hash_algorithm": {
          "type": "string"
        },
        "columns": {
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "normalization": {
          "$ref": "#/$defs/Normalization"
        },
        "column_mapping": {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object"
        },
        "stages": {
          "items": {
            "$ref": "#/$defs/StageAudit"
          },
          "type": "array"
        },
        "warnings": {
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "overall_match": {
          "type": "boolean"
        },
        "error": {
          "type": "string"
        }
      },
      "type": "object",
      "required": [
        "name",
        "mode",
        "source",
        "target",
        "key_column",
        "stages",
        "overall_match"
      ]
    },
    "RowMismatchAudit": {
      "properties": {
        "pk": true,
        "type": {
          "type": "string",
          "enum": [
            "missing_in_target",
            "missing_in_source",
            "modified"
          ]
        },
        "source_row_hash": {
          "type": "integer"
        },
        "target_row_hash": {
          "type": "integer"
        },
        "source_values": {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object"
        },
        "target_values": {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object"
        }
      },
      "type": "object",
      "required": [
        "pk",
        "type"
      ]
    },
    "SegmentAuditNode": {
      "properties": {
        "segment": {
          "$ref": "#/$defs/SegmentInfo"
        },
        "source_count": {
          "type": "integer"
        },
        "target_count": {
          "type": "integer"
        },
        "source_checksum": {
          "type": "integer"
        },
        "target_checksum": {
          "type": "integer"
        },
        "match": {
          "type": "boolean"
        },
        "is_leaf": {
          "type": "boolean"
        },
        "termination_reason": {
          "type": "string",
          "enum": [
            "threshold_reached",
            "max_depth_reached",
            "empty_segment",
            "cannot_split",
            "matched",
            "error"
          ]
        },
        "mismatch_rows_in_subtree": {
          "type": "integer",
          "minimum": 0
        },
        "total_rows_in_subtree": {
          "type": "integer",
          "minimum": 0
        },
        "query_ids": {
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "children": {
          "items": {
            "$ref": "#/$defs/SegmentAuditNode"
          },
          "type": "array"
        },
        "row_mismatches": {
          "items": {
            "$ref": "#/$defs/RowMismatchAudit"
          },
          "type": "array"
        }
      },
      "type": "object",
      "required": [
        "match",
        "is_leaf"
      ]
    },
    "SegmentInfo": {
      "properties": {
        "min_key": true,
        "max_key": true,
        "depth": {
          "type": "integer",
          "minimum": 0
        },
        "index": {
          "type": "integer",
          "minimum": 0
        },
        "time_bucket": {
          "type": "string"
        }
      },
      "type": "object"
    },
    "StageAudit": {
      "properties": {
        "stage": {
          "type": "string",
          "enum": [
            "quick_check",
            "bisection_drill",
            "aggregate_check"
          ]
        },
        "started_at": {
          "type": "string",
          "format": "date-time"
        },
        "completed_at": {
          "type": "string",
          "format": "date-time"
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0
        },
        "config": true,
        "queries": {
          "items": {
            "$ref": "#/$defs/QueryRecord"
          },
          "type": "array"
        },
        "segment_tree": {
          "$ref": "#/$defs/SegmentAuditNode"
        },
        "result": true
      },
      "type": "object",
      "required": [
        "stage",
        "started_at",
        "completed_at",
        "duration_ms",
        "queries"
      ]
    }
  },
  "properties": {
    "version": {
      "type": "string",
      "const": "1",
      "description": "Schema version"
    },
    "invocation_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this invocation/run"
    },
    "meta": {
      "$ref": "#/$defs/AuditMeta",
      "description": "Build and environment metadata for the synq-recon binary"
    },
    "config_file": {
      "type": "string",
      "description": "Path to the configuration file used"
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of the configuration suite"
    },
    "variables": {
      "additionalProperties": {
        "type": "string"
      },
      "type": "object",
      "description": "Resolved template variable values used for query interpolation"
    },
    "started_at": {
      "type": "string",
      "format": "date-time",
      "description": "RFC3339 timestamp when the run started"
    },
    "completed_at": {
      "type": "string",
      "format": "date-time",
      "description": "RFC3339 timestamp when the run completed"
    },
    "duration_ms": {
      "type": "integer",
      "minimum": 0,
      "description": "Total run duration in milliseconds"
    },
    "warnings": {
      "items": {
        "type": "string"
      },
      "type": "array",
      "description": "Suite-level warnings detected during config validation"
    },
    "reconciliations": {
      "items": {
        "$ref": "#/$defs/ReconciliationAudit"
      },
      "type": "array",
      "description": "Audit records for each reconciliation executed"
    }
  },
  "type": "object",
  "required": [
    "version",
    "started_at",
    "completed_at",
    "duration_ms",
    "reconciliations"
  ],
  "title": "SYNQ Recon Audit Log",
  "description": "Audit log capturing all operations performed during a synq-recon reconciliation run",
  "x-status": "draft"
}
