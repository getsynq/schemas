{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.synq.io/synq-recon/draft/audit-log.schema.json",
  "$defs": {
    "AggregateDrillChild": {
      "properties": {
        "key": {
          "type": "object"
        },
        "type": {
          "type": "string",
          "enum": [
            "mismatch",
            "missing_source",
            "missing_target",
            "value_mismatch"
          ]
        },
        "source_values": {
          "additionalProperties": {
            "type": "number"
          },
          "type": "object"
        },
        "target_values": {
          "additionalProperties": {
            "type": "number"
          },
          "type": "object"
        },
        "differences": {
          "$ref": "#/$defs/MeasureDifferences"
        },
        "threshold_evaluation": {
          "$ref": "#/$defs/ThresholdEvaluation"
        },
        "source_query": {
          "type": "string"
        },
        "target_query": {
          "type": "string"
        },
        "drill_down": {
          "$ref": "#/$defs/AggregateDrillNode"
        }
      },
      "type": "object",
      "description": "AggregateDrillChild represents a single divergent group within a drill-down level."
    },
    "AggregateDrillNode": {
      "properties": {
        "level": {
          "type": "integer"
        },
        "group_column": {
          "type": "string"
        },
        "total_groups": {
          "type": "integer"
        },
        "matched_groups": {
          "type": "integer"
        },
        "children": {
          "items": {
            "$ref": "#/$defs/AggregateDrillChild"
          },
          "type": "array"
        }
      },
      "type": "object",
      "description": "AggregateDrillNode represents a node in the hierarchical aggregate drill-down tree."
    },
    "AggregateStageResult": {
      "properties": {
        "total_groups": {
          "type": "integer"
        },
        "matched_groups": {
          "type": "integer"
        },
        "mismatch_groups": {
          "type": "integer"
        },
        "missing_source": {
          "type": "integer"
        },
        "missing_target": {
          "type": "integer"
        },
        "match": {
          "type": "boolean"
        },
        "early_termination_reason": {
          "type": "string"
        },
        "drill_down": {
          "$ref": "#/$defs/AggregateDrillNode"
        }
      },
      "type": "object",
      "description": "AggregateStageResult is the typed result for an aggregate_check stage."
    },
    "AuditMeta": {
      "properties": {
        "version": {
          "type": "string",
          "description": "Module version or tag (e.g. v1.2.3)"
        },
        "vcs_commit": {
          "type": "string",
          "description": "VCS revision hash"
        },
        "vcs_time": {
          "type": "string",
          "description": "VCS commit timestamp (RFC3339)"
        },
        "vcs_dirty": {
          "type": "boolean",
          "description": "True if the working tree had uncommitted changes"
        },
        "go_version": {
          "type": "string",
          "description": "Go toolchain version used to build the binary"
        }
      },
      "type": "object",
      "description": "AuditMeta holds build and environment metadata for the synq-recon binary."
    },
    "AuditSummary": {
      "properties": {
        "overall_match": {
          "type": "boolean",
          "description": "True when every reconciliation matched (exactly or within threshold)"
        },
        "total": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of reconciliations executed"
        },
        "matched": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of reconciliations that completed and matched exactly"
        },
        "matched_within_threshold": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of reconciliations that had differences within configured thresholds"
        },
        "mismatched": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of reconciliations that completed but found data differences exceeding thresholds"
        },
        "failed": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of reconciliations that encountered an infrastructure error"
        }
      },
      "type": "object",
      "required": [
        "overall_match",
        "total"
      ],
      "description": "AuditSummary holds aggregated counts derived from individual reconciliation results."
    },
    "BisectionStageConfig": {
      "properties": {
        "factor": {
          "type": "integer"
        },
        "threshold": {
          "type": "integer"
        },
        "max_depth": {
          "type": "integer"
        },
        "strategy": {
          "type": "string"
        }
      },
      "type": "object",
      "description": "BisectionStageConfig is the typed config for a bisection_drill stage."
    },
    "BisectionStageResult": {
      "properties": {
        "total_segments": {
          "type": "integer"
        },
        "mismatch_count": {
          "type": "integer"
        },
        "error_count": {
          "type": "integer"
        },
        "max_depth": {
          "type": "integer"
        },
        "early_termination_reason": {
          "type": "string"
        },
        "statistics": {
          "$ref": "#/$defs/BisectionStatistics"
        },
        "mismatch_leaves": {
          "items": {
            "$ref": "#/$defs/MismatchLeafDetail"
          },
          "type": "array"
        },
        "investigation_queries": {
          "items": {
            "$ref": "#/$defs/InvestigationQuery"
          },
          "type": "array"
        }
      },
      "type": "object",
      "description": "BisectionStageResult is the typed result for a bisection_drill stage."
    },
    "BisectionStatistics": {
      "properties": {
        "total_nodes": {
          "type": "integer"
        },
        "matched_nodes": {
          "type": "integer"
        },
        "mismatched_nodes": {
          "type": "integer"
        },
        "leaf_nodes": {
          "type": "integer"
        },
        "intermediate_nodes": {
          "type": "integer"
        },
        "matched_leaves": {
          "type": "integer"
        },
        "mismatched_leaves": {
          "type": "integer"
        },
        "depth_distribution": {
          "patternProperties": {
            "^[0-9]+$": {
              "type": "integer"
            }
          },
          "additionalProperties": false,
          "type": "object"
        },
        "mismatch_by_depth": {
          "patternProperties": {
            "^[0-9]+$": {
              "type": "integer"
            }
          },
          "additionalProperties": false,
          "type": "object"
        },
        "per_depth": {
          "additionalProperties": {
            "$ref": "#/$defs/DepthStats"
          },
          "type": "object"
        },
        "total_source_rows": {
          "type": "integer"
        },
        "total_target_rows": {
          "type": "integer"
        },
        "mismatch_source_rows": {
          "type": "integer"
        },
        "mismatch_target_rows": {
          "type": "integer"
        }
      },
      "type": "object",
      "description": "BisectionStatistics holds statistics about the bisection segment tree."
    },
    "DatasetInfo": {
      "properties": {
        "connection": {
          "type": "string"
        },
        "dialect": {
          "type": "string"
        },
        "query": {
          "type": "string"
        }
      },
      "type": "object",
      "required": [
        "connection",
        "query"
      ],
      "description": "DatasetInfo identifies a source or target dataset."
    },
    "DepthStats": {
      "properties": {
        "total_rows": {
          "type": "integer"
        },
        "mismatched_rows": {
          "type": "integer"
        },
        "segments": {
          "type": "integer"
        },
        "mismatched_segments": {
          "type": "integer"
        }
      },
      "type": "object",
      "description": "DepthStats holds per-depth-level statistics for the bisection tree."
    },
    "DiffQueriesAudit": {
      "properties": {
        "source_rows": {
          "type": "string"
        },
        "target_rows": {
          "type": "string"
        }
      },
      "type": "object",
      "description": "DiffQueriesAudit holds investigation queries for a mismatch leaf."
    },
    "InvestigationQuery": {
      "properties": {
        "min_key": {
          "anyOf": [
            {
              "type": "integer"
            },
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ]
        },
        "max_key": {
          "anyOf": [
            {
              "type": "integer"
            },
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ]
        },
        "time_bucket": {
          "type": "string"
        },
        "leaves_covered": {
          "type": "integer",
          "minimum": 1
        },
        "source_query": {
          "type": "string"
        },
        "target_query": {
          "type": "string"
        }
      },
      "type": "object",
      "required": [
        "min_key",
        "max_key",
        "leaves_covered",
        "source_query",
        "target_query"
      ],
      "description": "InvestigationQuery represents a merged diff query covering one or more adjacent mismatch leaves."
    },
    "MeasureDifferences": {
      "properties": {
        "relative": {
          "additionalProperties": {
            "type": "number"
          },
          "type": "object",
          "description": "Relative difference per measure (target - source). Positive means target is larger."
        },
        "absolute": {
          "additionalProperties": {
            "type": "number"
          },
          "type": "object",
          "description": "Absolute difference per measure: |target - source|. Always non-negative."
        },
        "pct_vs_source": {
          "additionalProperties": {
            "type": "number"
          },
          "type": "object",
          "description": "Percentage difference relative to source: |diff| / |source|."
        },
        "pct_vs_target": {
          "additionalProperties": {
            "type": "number"
          },
          "type": "object",
          "description": "Percentage difference relative to target: |diff| / |target|."
        },
        "pct_symmetric": {
          "additionalProperties": {
            "type": "number"
          },
          "type": "object",
          "description": "Symmetric percentage difference: 2*|diff| / (|source| + |target|)."
        }
      },
      "type": "object",
      "description": "MeasureDifferences holds all difference variants for measure comparisons."
    },
    "MeasureVerdict": {
      "properties": {
        "exceeded": {
          "type": "boolean",
          "description": "Exceeded is true when the measure difference exceeds all configured thresholds."
        },
        "reason": {
          "type": "string",
          "enum": [
            "exact_match",
            "within_absolute_threshold",
            "within_percentage_threshold",
            "exceeded_all_thresholds",
            "no_thresholds_configured"
          ],
          "description": "Reason explains why the measure was considered within or outside thresholds."
        },
        "effective_absolute": {
          "type": "number",
          "description": "EffectiveAbsolute is the absolute threshold that was applied to this measure (may differ per measure via per_measure config)."
        },
        "effective_percentage": {
          "type": "number",
          "description": "EffectivePercentage is the percentage threshold that was applied to this measure."
        },
        "effective_percentage_mode": {
          "type": "string",
          "description": "EffectivePercentageMode is the percentage mode that was applied to this measure."
        }
      },
      "type": "object",
      "description": "MeasureVerdict captures the threshold evaluation result for a single measure."
    },
    "MismatchLeafDetail": {
      "properties": {
        "segment": {
          "$ref": "#/$defs/MismatchLeafSegment"
        },
        "source_count": {
          "type": "integer"
        },
        "target_count": {
          "type": "integer"
        },
        "source_checksum": {
          "type": "integer"
        },
        "target_checksum": {
          "type": "integer"
        },
        "count_difference": {
          "type": "integer"
        },
        "mismatch_types": {
          "items": {
            "type": "string",
            "enum": [
              "missing_in_source",
              "missing_in_target",
              "count_mismatch",
              "data_mismatch",
              "unknown"
            ]
          },
          "type": "array"
        },
        "termination_reason": {
          "type": "string",
          "enum": [
            "threshold_reached",
            "max_depth_reached",
            "empty_segment",
            "cannot_split",
            "matched",
            "error"
          ]
        },
        "diff_queries": {
          "$ref": "#/$defs/DiffQueriesAudit"
        },
        "row_mismatches": {
          "items": {
            "$ref": "#/$defs/RowMismatchDetail"
          },
          "type": "array"
        },
        "row_mismatch_count": {
          "type": "integer"
        }
      },
      "type": "object",
      "description": "MismatchLeafDetail holds detailed information about a single mismatch leaf."
    },
    "MismatchLeafSegment": {
      "properties": {
        "min_key": {
          "anyOf": [
            {
              "type": "integer"
            },
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ]
        },
        "max_key": {
          "anyOf": [
            {
              "type": "integer"
            },
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ]
        },
        "depth": {
          "type": "integer",
          "minimum": 0
        },
        "index": {
          "type": "integer",
          "minimum": 0
        }
      },
      "type": "object",
      "description": "MismatchLeafSegment identifies the segment of a mismatch leaf."
    },
    "Normalization": {
      "properties": {
        "source_columns": {
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "target_columns": {
          "items": {
            "type": "string"
          },
          "type": "array"
        }
      },
      "type": "object",
      "description": "Normalization records the column expressions used after cross-DB type alignment."
    },
    "QueryRecord": {
      "properties": {
        "id": {
          "type": "string"
        },
        "role": {
          "type": "string",
          "enum": [
            "source",
            "target"
          ]
        },
        "connection": {
          "type": "string"
        },
        "dialect": {
          "type": "string"
        },
        "sql": {
          "type": "string"
        },
        "started_at": {
          "type": "string",
          "format": "date-time"
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0
        },
        "rows_returned": {
          "type": "integer",
          "minimum": 0
        },
        "error": {
          "type": "string"
        },
        "retry_attempt": {
          "type": "integer",
          "minimum": 0
        },
        "stats": {
          "$ref": "#/$defs/QueryStats"
        }
      },
      "type": "object",
      "required": [
        "id",
        "role",
        "connection",
        "sql",
        "started_at",
        "duration_ms"
      ],
      "description": "QueryRecord captures a single SQL query execution."
    },
    "QueryStats": {
      "properties": {
        "query_id": {
          "type": "string",
          "description": "QueryID is the database-assigned query identifier for auditing.\nAvailable for BigQuery (job ID), Snowflake, ClickHouse (client-generated)."
        },
        "rows_read": {
          "type": "integer",
          "description": "RowsRead is the number of rows read/scanned by the query engine."
        },
        "bytes_read": {
          "type": "integer",
          "description": "BytesRead is the number of bytes read/scanned by the query engine."
        },
        "rows_produced": {
          "type": "integer",
          "description": "RowsProduced is the number of result rows returned to the caller."
        },
        "cache_hit": {
          "type": "boolean",
          "description": "CacheHit indicates whether the query result was served from cache."
        },
        "bytes_billed": {
          "type": "integer",
          "description": "BytesBilled is the number of bytes billed (BigQuery)."
        },
        "slot_millis": {
          "type": "integer",
          "description": "SlotMillis is the slot time consumed (BigQuery)."
        },
        "blocks": {
          "type": "integer",
          "description": "Blocks is the number of data blocks read (ClickHouse)."
        },
        "completed_splits": {
          "type": "integer",
          "description": "CompletedSplits is the number of completed splits (Trino)."
        },
        "cpu_time_millis": {
          "type": "integer",
          "description": "CPUTimeMillis is the CPU time consumed (Trino)."
        },
        "wall_time_millis": {
          "type": "integer",
          "description": "WallTimeMillis is the wall time reported by the engine (Trino)."
        }
      },
      "type": "object",
      "description": "QueryStats holds execution statistics collected from the database driver."
    },
    "QuickCheckStageResult": {
      "properties": {
        "source_count": {
          "type": "integer"
        },
        "target_count": {
          "type": "integer"
        },
        "source_checksum": {
          "type": "integer"
        },
        "target_checksum": {
          "type": "integer"
        },
        "match": {
          "type": "boolean"
        },
        "count_difference": {
          "type": "integer"
        },
        "error": {
          "type": "string"
        }
      },
      "type": "object",
      "description": "QuickCheckStageResult is the typed result for a quick_check stage."
    },
    "ReconciliationAudit": {
      "properties": {
        "name": {
          "type": "string",
          "description": "Machine identifier (YAML key)"
        },
        "title": {
          "type": "string",
          "description": "Human-readable title (from YAML title field or falls back to name)"
        },
        "description": {
          "type": "string"
        },
        "mode": {
          "type": "string",
          "enum": [
            "row_count",
            "full",
            "aggregate"
          ]
        },
        "config": {
          "type": "object"
        },
        "raw_config": {
          "type": "object"
        },
        "source": {
          "$ref": "#/$defs/DatasetInfo"
        },
        "target": {
          "$ref": "#/$defs/DatasetInfo"
        },
        "original_source_query": {
          "type": "string"
        },
        "original_target_query": {
          "type": "string"
        },
        "key_column": {
          "type": "string"
        },
        "hash_algorithm": {
          "type": "string"
        },
        "columns": {
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "normalization": {
          "$ref": "#/$defs/Normalization"
        },
        "column_mapping": {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object"
        },
        "stages": {
          "items": {
            "$ref": "#/$defs/StageAudit"
          },
          "type": "array"
        },
        "warnings": {
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "status": {
          "type": "string",
          "enum": [
            "passed",
            "failed",
            "mismatched",
            "mismatched_within_threshold"
          ],
          "description": "Outcome of this reconciliation"
        },
        "overall_match": {
          "type": "boolean"
        },
        "error": {
          "type": "string"
        }
      },
      "type": "object",
      "required": [
        "name",
        "mode",
        "source",
        "target",
        "key_column",
        "stages",
        "status",
        "overall_match"
      ],
      "description": "ReconciliationAudit captures everything about a single reconciliation execution."
    },
    "RowMismatchAudit": {
      "properties": {
        "pk": {
          "anyOf": [
            {
              "type": "integer"
            },
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ]
        },
        "type": {
          "type": "string",
          "enum": [
            "missing_in_target",
            "missing_in_source",
            "modified"
          ]
        },
        "source_row_hash": {
          "type": "integer"
        },
        "target_row_hash": {
          "type": "integer"
        },
        "source_values": {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object"
        },
        "target_values": {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object"
        }
      },
      "type": "object",
      "required": [
        "pk",
        "type"
      ],
      "description": "RowMismatchAudit captures a single row-level mismatch in the audit log."
    },
    "RowMismatchDetail": {
      "properties": {
        "pk": {
          "anyOf": [
            {
              "type": "integer"
            },
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ]
        },
        "type": {
          "type": "string",
          "enum": [
            "missing_in_target",
            "missing_in_source",
            "modified"
          ]
        },
        "source_row_hash": {
          "type": "integer"
        },
        "target_row_hash": {
          "type": "integer"
        }
      },
      "type": "object",
      "description": "RowMismatchDetail holds per-row mismatch detail in the stage result."
    },
    "SegmentAuditNode": {
      "properties": {
        "segment": {
          "$ref": "#/$defs/SegmentInfo"
        },
        "source_count": {
          "type": "integer"
        },
        "target_count": {
          "type": "integer"
        },
        "source_checksum": {
          "type": "integer"
        },
        "target_checksum": {
          "type": "integer"
        },
        "match": {
          "type": "boolean"
        },
        "is_leaf": {
          "type": "boolean"
        },
        "termination_reason": {
          "type": "string",
          "enum": [
            "threshold_reached",
            "max_depth_reached",
            "empty_segment",
            "cannot_split",
            "matched",
            "error"
          ]
        },
        "mismatch_rows_in_subtree": {
          "type": "integer",
          "minimum": 0
        },
        "total_rows_in_subtree": {
          "type": "integer",
          "minimum": 0
        },
        "query_ids": {
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "children": {
          "items": {
            "$ref": "#/$defs/SegmentAuditNode"
          },
          "type": "array"
        },
        "row_mismatches": {
          "items": {
            "$ref": "#/$defs/RowMismatchAudit"
          },
          "type": "array"
        }
      },
      "type": "object",
      "required": [
        "match",
        "is_leaf"
      ],
      "description": "SegmentAuditNode represents a node in the bisection segment tree with query references."
    },
    "SegmentInfo": {
      "properties": {
        "min_key": {
          "anyOf": [
            {
              "type": "integer"
            },
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ]
        },
        "max_key": {
          "anyOf": [
            {
              "type": "integer"
            },
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ]
        },
        "depth": {
          "type": "integer",
          "minimum": 0
        },
        "index": {
          "type": "integer",
          "minimum": 0
        },
        "time_bucket": {
          "type": "string"
        }
      },
      "type": "object",
      "description": "SegmentInfo identifies a key range segment."
    },
    "StageAudit": {
      "properties": {
        "stage": {
          "type": "string",
          "enum": [
            "quick_check",
            "bisection_drill",
            "aggregate_check"
          ]
        },
        "started_at": {
          "type": "string",
          "format": "date-time"
        },
        "completed_at": {
          "type": "string",
          "format": "date-time"
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0
        },
        "config": {
          "anyOf": [
            {
              "$ref": "#/$defs/BisectionStageConfig"
            }
          ]
        },
        "queries": {
          "items": {
            "$ref": "#/$defs/QueryRecord"
          },
          "type": "array"
        },
        "segment_tree": {
          "$ref": "#/$defs/SegmentAuditNode"
        },
        "result": {
          "anyOf": [
            {
              "$ref": "#/$defs/QuickCheckStageResult"
            },
            {
              "$ref": "#/$defs/BisectionStageResult"
            },
            {
              "$ref": "#/$defs/AggregateStageResult"
            }
          ]
        }
      },
      "type": "object",
      "required": [
        "stage",
        "started_at",
        "completed_at",
        "duration_ms",
        "queries"
      ],
      "description": "StageAudit captures one reconciliation stage (quick_check, bisection_drill, aggregate_check)."
    },
    "ThresholdEvaluation": {
      "properties": {
        "absolute_threshold": {
          "type": "number",
          "description": "AbsoluteThreshold is the configured maximum absolute difference, or 0 if not set."
        },
        "percentage_threshold": {
          "type": "number",
          "description": "PercentageThreshold is the configured maximum percentage difference, or 0 if not set."
        },
        "percentage_mode": {
          "type": "string",
          "description": "PercentageMode is which percentage formula was used: source, target, or symmetric."
        },
        "measures": {
          "additionalProperties": {
            "$ref": "#/$defs/MeasureVerdict"
          },
          "type": "object",
          "description": "Measures holds per-measure threshold evaluation results."
        }
      },
      "type": "object",
      "description": "ThresholdEvaluation captures the effective thresholds applied and per-measure verdicts."
    }
  },
  "properties": {
    "version": {
      "type": "string",
      "const": "1",
      "description": "Schema version"
    },
    "invocation_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this invocation/run"
    },
    "meta": {
      "$ref": "#/$defs/AuditMeta"
    },
    "config_file": {
      "type": "string",
      "description": "Path to the configuration file used"
    },
    "suite": {
      "type": "string",
      "description": "Machine identifier for the config suite (from YAML name field or filename)"
    },
    "suite_title": {
      "type": "string",
      "description": "Human-readable title of the config suite (from YAML title field or falls back to suite id)"
    },
    "description": {
      "type": "string",
      "description": "Longer description of the configuration suite"
    },
    "variables": {
      "additionalProperties": {
        "type": "string"
      },
      "type": "object",
      "description": "Resolved template variable values used for query interpolation"
    },
    "started_at": {
      "type": "string",
      "format": "date-time",
      "description": "RFC3339 timestamp when the run started"
    },
    "completed_at": {
      "type": "string",
      "format": "date-time",
      "description": "RFC3339 timestamp when the run completed"
    },
    "duration_ms": {
      "type": "integer",
      "minimum": 0,
      "description": "Total run duration in milliseconds"
    },
    "warnings": {
      "items": {
        "type": "string"
      },
      "type": "array",
      "description": "Suite-level warnings detected during config validation"
    },
    "reconciliations": {
      "items": {
        "$ref": "#/$defs/ReconciliationAudit"
      },
      "type": "array",
      "description": "Audit records for each reconciliation executed"
    },
    "total_stats": {
      "$ref": "#/$defs/QueryStats"
    },
    "status": {
      "type": "string",
      "enum": [
        "passed",
        "failed",
        "mismatched",
        "mismatched_within_threshold"
      ],
      "description": "Overall execution status derived from individual reconciliation outcomes"
    },
    "summary": {
      "$ref": "#/$defs/AuditSummary"
    }
  },
  "type": "object",
  "required": [
    "version",
    "started_at",
    "completed_at",
    "duration_ms",
    "reconciliations",
    "status"
  ],
  "title": "SYNQ Recon Audit Log",
  "description": "Audit log capturing all operations performed during a synq-recon reconciliation run",
  "x-status": "draft"
}
