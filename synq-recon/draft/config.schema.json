{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.synq.io/synq-recon/draft/config.schema.json",
  "title": "SYNQ Recon Configuration",
  "x-status": "draft",
  "description": "Configuration file format for synq-recon database reconciliation tool",
  "type": "object",
  "required": ["connections", "reconciliations"],
  "properties": {
    "description": {
      "type": "string",
      "description": "Human-readable description of the configuration suite"
    },
    "connections": {
      "type": "object",
      "description": "Database connection definitions",
      "additionalProperties": { "$ref": "#/$defs/connection" },
      "minProperties": 1
    },
    "reconciliations": {
      "type": "object",
      "description": "Reconciliation scenario definitions",
      "additionalProperties": { "$ref": "#/$defs/reconciliation" },
      "minProperties": 1
    }
  },
  "$defs": {
    "connection": {
      "type": "object",
      "description": "A database connection. Exactly one database type key must be present.",
      "properties": {
        "name": { "type": "string", "description": "Optional display name" },
        "parallelism": { "type": "integer", "minimum": 1, "default": 8, "description": "Max parallel queries" },
        "disabled": { "type": "boolean", "default": false },
        "postgres": { "$ref": "#/$defs/postgres_config" },
        "snowflake": { "$ref": "#/$defs/snowflake_config" },
        "bigquery": { "$ref": "#/$defs/bigquery_config" },
        "mysql": { "$ref": "#/$defs/mysql_config" },
        "clickhouse": { "$ref": "#/$defs/clickhouse_config" },
        "duckdb": { "$ref": "#/$defs/duckdb_config" },
        "databricks": { "$ref": "#/$defs/databricks_config" },
        "redshift": { "$ref": "#/$defs/redshift_config" },
        "trino": { "$ref": "#/$defs/trino_config" },
        "mssql": { "$ref": "#/$defs/mssql_config" },
        "oracle": { "$ref": "#/$defs/oracle_config" }
      }
    },
    "postgres_config": {
      "type": "object",
      "required": ["host", "database", "username"],
      "properties": {
        "host": { "type": "string" },
        "port": { "type": "integer", "default": 5432 },
        "database": { "type": "string" },
        "username": { "type": "string" },
        "password": { "type": "string" },
        "allow_insecure": { "type": "boolean", "default": false }
      }
    },
    "snowflake_config": {
      "type": "object",
      "required": ["account", "username"],
      "properties": {
        "account": { "type": "string", "description": "Snowflake account identifier" },
        "warehouse": { "type": "string", "description": "Virtual warehouse to use" },
        "role": { "type": "string", "description": "Role to assume" },
        "username": { "type": "string", "description": "Username for authentication" },
        "password": { "type": "string", "description": "Password for authentication" },
        "private_key": { "type": "string", "description": "Private key content for Snowflake authentication" },
        "private_key_file": { "type": "string", "description": "Path to private key file" },
        "private_key_passphrase": { "type": "string", "description": "Passphrase to decode private key" },
        "auth_type": { "type": "string", "description": "Authentication type (e.g., 'externalbrowser' for SSO)" },
        "databases": { "type": "array", "items": { "type": "string" }, "description": "Databases to connect to" }
      }
    },
    "bigquery_config": {
      "type": "object",
      "required": ["project_id"],
      "properties": {
        "project_id": { "type": "string", "description": "GCP project ID" },
        "region": { "type": "string", "description": "Region for BigQuery resources" },
        "service_account_key": { "type": "string", "description": "Service account key JSON content" },
        "service_account_key_file": { "type": "string", "description": "Path to service account key file" }
      }
    },
    "mysql_config": {
      "type": "object",
      "required": ["host", "database", "username"],
      "properties": {
        "host": { "type": "string", "description": "Host address" },
        "port": { "type": "integer", "default": 3306, "description": "Port number" },
        "database": { "type": "string", "description": "Database name" },
        "username": { "type": "string", "description": "Username for authentication" },
        "password": { "type": "string", "description": "Password for authentication" },
        "allow_insecure": { "type": "boolean", "default": false, "description": "Whether to allow insecure connections" },
        "params": { "type": "object", "additionalProperties": { "type": "string" }, "description": "Additional connection parameters" }
      }
    },
    "clickhouse_config": {
      "type": "object",
      "required": ["host"],
      "properties": {
        "host": { "type": "string", "description": "Host address" },
        "port": { "type": "integer", "default": 9000, "description": "Port number" },
        "database": { "type": "string", "description": "Database name" },
        "username": { "type": "string", "description": "Username for authentication" },
        "password": { "type": "string", "description": "Password for authentication" },
        "allow_insecure": { "type": "boolean", "default": false, "description": "Whether to disable SSL for connection" }
      }
    },
    "duckdb_config": {
      "type": "object",
      "required": ["database"],
      "properties": {
        "database": {
          "type": "string",
          "description": "File path, ':memory:' for in-memory, or MotherDuck account name"
        },
        "motherduck_token": {
          "type": "string",
          "description": "MotherDuck authentication token (required for cloud MotherDuck)"
        }
      }
    },
    "databricks_config": {
      "type": "object",
      "required": ["workspace_url"],
      "properties": {
        "workspace_url": { "type": "string", "description": "Databricks workspace URL" },
        "auth_token": { "type": "string", "description": "Authentication token" },
        "auth_client": { "type": "string", "description": "OAuth client ID" },
        "auth_secret": { "type": "string", "description": "OAuth client secret" },
        "warehouse": { "type": "string", "description": "SQL warehouse ID" }
      }
    },
    "redshift_config": {
      "type": "object",
      "required": ["host", "database", "username"],
      "properties": {
        "host": { "type": "string" },
        "port": { "type": "integer", "default": 5439 },
        "database": { "type": "string" },
        "username": { "type": "string" },
        "password": { "type": "string" }
      }
    },
    "trino_config": {
      "type": "object",
      "required": ["host"],
      "properties": {
        "host": { "type": "string", "description": "Host address" },
        "port": { "type": "integer", "default": 8080, "description": "Port number" },
        "catalogs": { "type": "array", "items": { "type": "string" }, "description": "Catalogs to connect to" },
        "username": { "type": "string", "description": "Username for authentication" },
        "password": { "type": "string", "description": "Password for authentication" },
        "use_plaintext": { "type": "boolean", "default": false, "description": "Use non-SSL connection" }
      }
    },
    "mssql_config": {
      "type": "object",
      "required": ["server", "database", "username"],
      "properties": {
        "server": { "type": "string", "description": "Server hostname or IP address" },
        "port": { "type": "integer", "default": 1433, "description": "Port number" },
        "database": { "type": "string", "description": "Database name" },
        "username": { "type": "string", "description": "Database username" },
        "password": { "type": "string", "description": "Database password" },
        "instance": { "type": "string", "description": "Named instance (optional)" }
      }
    },
    "oracle_config": {
      "type": "object",
      "required": ["host", "username"],
      "properties": {
        "host": { "type": "string", "description": "Server hostname or IP address" },
        "port": { "type": "integer", "default": 1521, "description": "Port number" },
        "service_name": { "type": "string", "description": "Oracle service name" },
        "sid": { "type": "string", "description": "Oracle SID (alternative to service_name)" },
        "username": { "type": "string", "description": "Login user" },
        "password": { "type": "string", "description": "Login password" }
      }
    },
    "reconciliation": {
      "type": "object",
      "required": ["source", "target", "key_column"],
      "properties": {
        "description": { "type": "string" },
        "source": { "$ref": "#/$defs/dataset" },
        "target": { "$ref": "#/$defs/dataset" },
        "key_column": {
          "type": "string",
          "description": "Column used for bisection split points and aggregate grouping"
        },
        "mode": {
          "type": "string",
          "enum": ["row_count", "full", "aggregate"],
          "default": "full",
          "description": "Reconciliation mode"
        },
        "hash_algorithm": {
          "type": "string",
          "enum": ["auto", "md5", "farm_fingerprint", "xxhash64"],
          "default": "auto",
          "description": "Hash algorithm for row checksums"
        },
        "column_mapping": {
          "oneOf": [
            {
              "type": "object",
              "description": "Map source column names to target column names (object format)",
              "additionalProperties": { "type": "string" }
            },
            {
              "type": "array",
              "description": "Map source column names to target column names (array format)",
              "items": { "$ref": "#/$defs/column_mapping_entry" }
            }
          ],
          "description": "Column name mapping between source and target datasets"
        },
        "case_insensitive": {
          "type": "boolean",
          "default": true,
          "description": "Automatically match columns case-insensitively (e.g., user_id matches USER_ID)"
        },
        "bisection": { "$ref": "#/$defs/bisection_config" },
        "reporting": { "$ref": "#/$defs/reporting_config" },
        "aggregate": { "$ref": "#/$defs/aggregate_config" }
      }
    },
    "dataset": {
      "type": "object",
      "required": ["connection"],
      "properties": {
        "connection": {
          "type": "string",
          "description": "Connection name (must exist in connections map)"
        },
        "query": {
          "type": "string",
          "description": "Base SQL query for this dataset (mutually exclusive with 'table')"
        },
        "table": {
          "type": "string",
          "description": "Table name or fully-qualified name (e.g., 'schema.table'). Alternative to 'query'."
        },
        "columns": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Explicit column list (only with 'table'). Mutually exclusive with 'exclude_columns'."
        },
        "exclude_columns": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Columns to exclude (only with 'table', resolved at runtime). Mutually exclusive with 'columns'."
        },
        "as_of": {
          "type": "string",
          "description": "Time-travel timestamp (e.g., '2026-02-01 00:00:00')"
        }
      },
      "oneOf": [
        { "required": ["query"] },
        { "required": ["table"] }
      ]
    },
    "bisection_config": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean", "default": true },
        "factor": {
          "type": "integer",
          "minimum": 2,
          "default": 32,
          "description": "Number of segments to split into per bisection level"
        },
        "threshold": {
          "type": "integer",
          "minimum": 1,
          "default": 16384,
          "description": "Stop drilling when segment row count falls below this"
        },
        "strategy": {
          "type": "string",
          "enum": ["auto", "quantile", "hash", "time"],
          "default": "auto",
          "description": "Segmentation strategy for bisection drill-down"
        },
        "time_column": {
          "type": "string",
          "description": "Column containing timestamps for time-based partitioning (required when strategy is 'time')"
        },
        "time_granularity": {
          "type": "string",
          "enum": ["hour", "day", "week", "month", "quarter", "year"],
          "default": "day",
          "description": "Time truncation granularity for time-based partitioning"
        }
      }
    },
    "reporting_config": {
      "type": "object",
      "properties": {
        "level": {
          "type": "string",
          "enum": ["count_only", "with_keys", "detailed"],
          "default": "count_only"
        },
        "sample_limit": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum number of sample rows to report"
        },
        "consent_acknowledged": {
          "type": "boolean",
          "default": false,
          "description": "Required for detailed reporting level"
        }
      }
    },
    "aggregate_config": {
      "type": "object",
      "required": ["measures"],
      "properties": {
        "measures": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/measure_config" }
        },
        "group_columns": {
          "oneOf": [
            { "type": "string", "description": "Single group column" },
            { "type": "array", "items": { "type": "string" }, "minItems": 1, "description": "Hierarchical group columns for drill-down" }
          ],
          "description": "Column(s) defining the drill-down hierarchy; falls back to key_column if not set"
        },
        "thresholds": { "$ref": "#/$defs/threshold_config" }
      }
    },
    "measure_config": {
      "type": "object",
      "required": ["column", "function"],
      "properties": {
        "column": { "type": "string" },
        "function": {
          "oneOf": [
            {
              "type": "string",
              "enum": ["SUM", "COUNT", "AVG", "MIN", "MAX"],
              "description": "Single aggregation function"
            },
            {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["SUM", "COUNT", "AVG", "MIN", "MAX"]
              },
              "minItems": 1,
              "description": "Multiple aggregation functions per column"
            }
          ],
          "description": "Aggregation function(s) to apply to the column"
        }
      }
    },
    "column_mapping_entry": {
      "type": "object",
      "required": ["source", "target"],
      "properties": {
        "source": {
          "type": "string",
          "description": "Source column name"
        },
        "target": {
          "type": "string",
          "description": "Target column name"
        }
      }
    },
    "threshold_config": {
      "type": "object",
      "properties": {
        "absolute": {
          "type": "number",
          "minimum": 0,
          "description": "Maximum absolute difference per measure"
        },
        "percentage": {
          "type": "number",
          "minimum": 0,
          "description": "Maximum percentage difference (0.1 = 10%)"
        },
        "percentage_mode": {
          "type": "string",
          "enum": ["source", "target", "symmetric"],
          "default": "source",
          "description": "Which percentage formula to use for threshold comparison: source (|diff|/|source|, default), target (|diff|/|target|), symmetric (2*|diff|/(|source|+|target|))"
        },
        "per_column": {
          "type": "object",
          "description": "Per group_column threshold overrides",
          "additionalProperties": { "$ref": "#/$defs/threshold_config" }
        }
      }
    }
  }
}
